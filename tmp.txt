Sub Deneme1()
    JoinForm.Show

End Sub

Sub Join(keys1 As Range, keys2 As Range, targetLocation As Range, newSheet As Boolean, fullCompare As Boolean)
        
    Dim target As Range
    
    If newSheet Then
        Sheets.Add After:=Sheets(Sheets.Count)
        Set target = Sheets(Sheets.Count).Range("A1")
    Else
        Set target = targetLocation
    End If
    

    
    ' sheet1 copy
    
    keys1.Worksheet.Activate
    keys1.Select
    Selection.CurrentRegion.Select
    columnCount1 = Selection.Columns.Count
    rowCount1 = Selection.Rows.Count
    Selection.Copy
    target.Worksheet.Activate
    target.Cells(1, 1).Select
    ActiveSheet.Paste
    
    
    ' sheet2 copy
    keys2.Worksheet.Activate
    keys2.Select
    Selection.CurrentRegion.Select
    columnCount2 = Selection.Columns.Count
    rowCount2 = Selection.Rows.Count
    Selection.Copy
    target.Worksheet.Activate
    target.Cells(1, columnCount1 + 1).Select
    ActiveSheet.Paste
    
    ' color1
    Range(target.Cells(1, 1), target.Cells(rowCount1, columnCount1)).Select
    Selection.Interior.Color = RGB(204, 229, 255)
    
    ' sort1
    target.Worksheet.Sort.SortFields.Clear
    Dim item As Variant
    For Each item In keys1
        target.Worksheet.Sort.SortFields.Add Key:=target.Columns(item.Column), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    Next
    
    With target.Worksheet.Sort
        .SetRange Selection
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With
    
    
    'color2
    Range(target.Cells(1, columnCount1 + 1), target.Cells(rowCount2, columnCount1 + columnCount2)).Select
    Selection.Interior.Color = RGB(215, 193, 193)
    
    'sort2
    target.Worksheet.Sort.SortFields.Clear
   
    Dim item2 As Variant
    For Each item2 In keys2
        target.Worksheet.Sort.SortFields.Add Key:=target.Columns(columnCount1 + item2.Column), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    Next
 
    With target.Worksheet.Sort
        .SetRange Selection
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With
    

        
    target.Cells(1, columnCount1 + columnCount2 + 1).Value = "Key Comparison"
    
    'full compare header columns
    If fullCompare Then
        For i = 1 To columnCount1
            target.Cells(1, columnCount1 + columnCount2 + 1 + i).Value = "c_" + CStr(Cells(1, i).Value)
        Next
    End If
    
    Dim currentRow
    currentRow = 2
        
    

    'join loop
    Do While True
        
        If IsEmpty(target.Cells(currentRow, 1)) And IsEmpty(target.Cells(currentRow, columnCount1 + 1)) Then
            Exit Do
        End If
        
        If currentRow >= 1000000 Then
            MsgBox "1000000 rows, canceling"
            Exit Do
        End If
        
        'compare
        Dim compare
        Dim item3 As Variant
        compare = 0
        For Each item3 In keys1
            If IsEmpty(target.Cells(currentRow, item3.Column).Value) And Not IsEmpty(target.Cells(currentRow, columnCount1 + item3.Column).Value) Then
                compare = 10
            ElseIf Not IsEmpty(target.Cells(currentRow, item3.Column).Value) And IsEmpty(target.Cells(currentRow, columnCount1 + item3.Column).Value) Then
                compare = 20
            ElseIf target.Cells(currentRow, item3.Column).Value > target.Cells(currentRow, columnCount1 + item3.Column).Value Then
                compare = 1
                Exit For
            ElseIf target.Cells(currentRow, item3.Column).Value < target.Cells(currentRow, columnCount1 + item3.Column).Value Then
                compare = 2
                Exit For
            End If
        Next item3
        
        'compare result actions , rowskip and color
        If compare = 1 Then
            Range(target.Cells(currentRow, 1), target.Cells(currentRow, columnCount1)).Select
            Selection.Insert Shift:=xlDown, CopyOrigin:=xlFormatFromLeftOrAbove
            target.Cells(currentRow, columnCount1 + columnCount2 + 1).Value = "Only2"
            target.Cells(currentRow, columnCount1 + columnCount2 + 1).Interior.Color = RGB(215, 193, 193)
        ElseIf compare = 2 Then
            Range(target.Cells(currentRow, columnCount1 + 1), target.Cells(currentRow, columnCount1 + columnCount2)).Select
            Selection.Insert Shift:=xlDown, CopyOrigin:=xlFormatFromLeftOrAbove
            target.Cells(currentRow, columnCount1 + columnCount2 + 1).Value = "Only1"
            target.Cells(currentRow, columnCount1 + columnCount2 + 1).Interior.Color = RGB(204, 229, 255)
        ElseIf compare = 10 Then
            target.Cells(currentRow, columnCount1 + columnCount2 + 1).Value = "Only2"
            target.Cells(currentRow, columnCount1 + columnCount2 + 1).Interior.Color = RGB(215, 193, 193)
        ElseIf compare = 20 Then
            target.Cells(currentRow, columnCount1 + columnCount2 + 1).Value = "Only1"
            target.Cells(currentRow, columnCount1 + columnCount2 + 1).Interior.Color = RGB(204, 229, 255)
        Else
            target.Cells(currentRow, columnCount1 + columnCount2 + 1).Value = "OK"
        End If
        
        'full compare , color
        If fullCompare Then
            For i = 1 To columnCount1
                If target.Cells(currentRow, i).Value = target.Cells(currentRow, i + columnCount1).Value Then
                    target.Cells(currentRow, columnCount1 + columnCount2 + 1 + i) = True
                Else
                    target.Cells(currentRow, columnCount1 + columnCount2 + 1 + i) = False
                    target.Cells(currentRow, i).Interior.Color = RGB(255, 255, 0)
                    target.Cells(currentRow, i + columnCount1).Interior.Color = RGB(255, 255, 0)
                    target.Cells(currentRow, columnCount1 + columnCount2 + 1 + i).Interior.Color = RGB(255, 204, 204)
                End If
                
                'Cells(currentRow, columnCount1 + columnCount2 + 1 + i).Formula = "=EXACT(" + Cells(currentRow, i).Address + "," + Cells(currentRow, i + columnCount1).Address + ")"
                                
            Next
        End If
       
        JoinForm.Label5.Caption = currentRow
        currentRow = currentRow + 1
        
    Loop
    

    'formula color - conditional formatting
'    If fullCompare = 1 Then
'
'        Cells(1, columnCount1 + columnCount2 + 2).Select
'        Range(Selection, Selection.End(xlToRight)).Select
'        Range(Selection, Selection.End(xlDown)).Select
'
'        Selection.FormatConditions.Add Type:=xlCellValue, Operator:=xlEqual, _
'            Formula1:="=FALSE"
'        Selection.FormatConditions(Selection.FormatConditions.Count).SetFirstPriority
'        With Selection.FormatConditions(1).Font
'            .Color = -16383844
'            .TintAndShade = 0
'        End With
'        With Selection.FormatConditions(1).Interior
'            .PatternColorIndex = xlAutomatic
'            .Color = 13551615
'            .TintAndShade = 0
'        End With
'        Selection.FormatConditions(1).StopIfTrue = False
'
'    End If
    
    
    'add filters
    target.Cells(1, 1).Select
    Selection.CurrentRegion.Select
    Selection.AutoFilter
        
    'key comparison column auto fit
    If newSheet Then
        Columns(columnCount1 + columnCount2 + 1).EntireColumn.AutoFit
    End If
     
    

    'Borders
    target.Cells(1, 1).Select
    Selection.CurrentRegion.Select
    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
    With Selection.Borders(xlEdgeLeft)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlEdgeTop)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlEdgeBottom)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlEdgeRight)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlInsideVertical)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlInsideHorizontal)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    Range("A1").Select
    
    
    
End Sub
 


